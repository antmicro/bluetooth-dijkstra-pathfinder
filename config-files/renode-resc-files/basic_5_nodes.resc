############################################################
# This file is used for demonstration purposes and should 
# not be modified or building process might break. If You 
# want to implement Your own .resc file, create a new one 
# and wire it manually to Renode.
############################################################

logLevel 0

emulation CreateWirelessMedium "wireless"
# emulation CreateWiresharkForWireless "wireless" #"bluetoothle"
# emulation LogToWireshark "wireless"
emulation LogWirelessTraffic
logLevel -1 wireless


# mesh begin  

#############################################################
# sink 
mach add "sink"
machine LoadPlatformDescription @platforms/cpus/nrf52840.repl 

# set unique identification address 
sysbus Tag <0x100000a4, 0x100000a7> "DEVICEADDR[0]" 0x0000000000 false

# time quantum setup 
emulation SetGlobalQuantum "0.00001"
emulation SetQuantum "0.00001"

# analyzers 
showAnalyzer sysbus.uart0
connector Connect sysbus.radio wireless

# logging 
logLevel -1 sysbus.radio
#logLevel -1 sysbus.ppi
#logLevel -1 sysbus.rtc0
#logLevel -1 sysbus.timer0
#logLevel -1 sysbus.timer1
logLevel -1 sysbus.nvic
sysbus LogPeripheralAccess sysbus.nvic
#sysbus LogPeripheralAccess sysbus.ppi
#sysbus LogPeripheralAccess sysbus.rtc0
#sysbus LogPeripheralAccess sysbus.timer0
#sysbus LogPeripheralAccess sysbus.timer1
sysbus LogPeripheralAccess sysbus.radio

#############################################################

# node 1 
mach add "node1"
mach set "node1"
machine LoadPlatformDescription @platforms/cpus/nrf52840.repl 

# set unique identification address 
sysbus Tag <0x100000a4, 0x100000a7> "DEVICEADDR[0]" 0x0000000001 false

# time quantum setup 
emulation SetGlobalQuantum "0.00001"
emulation SetQuantum "0.00001"

# analyzers 
showAnalyzer sysbus.uart0
connector Connect sysbus.radio wireless

# logging 
logLevel -1 sysbus.radio
#logLevel -1 sysbus.ppi
#logLevel -1 sysbus.rtc0
#logLevel -1 sysbus.timer0
#logLevel -1 sysbus.timer1
logLevel -1 sysbus.nvic
sysbus LogPeripheralAccess sysbus.nvic
#sysbus LogPeripheralAccess sysbus.ppi
#sysbus LogPeripheralAccess sysbus.rtc0
#sysbus LogPeripheralAccess sysbus.timer0
#sysbus LogPeripheralAccess sysbus.timer1
sysbus LogPeripheralAccess sysbus.radio

#############################################################

mach add "node2"
mach set "node2"
machine LoadPlatformDescription @platforms/cpus/nrf52840.repl 

# set unique identification address 
sysbus Tag <0x100000a4, 0x100000a7> "DEVICEADDR[0]" 0x0000000002 false

# time quantum setup 
emulation SetGlobalQuantum "0.00001"
emulation SetQuantum "0.00001"

# analyzers 
showAnalyzer sysbus.uart0
connector Connect sysbus.radio wireless

# logging 
logLevel -1 sysbus.radio
#logLevel -1 sysbus.ppi
#logLevel -1 sysbus.rtc0
#logLevel -1 sysbus.timer0
#logLevel -1 sysbus.timer1
logLevel -1 sysbus.nvic
sysbus LogPeripheralAccess sysbus.nvic
#sysbus LogPeripheralAccess sysbus.ppi
#sysbus LogPeripheralAccess sysbus.rtc0
#sysbus LogPeripheralAccess sysbus.timer0
#sysbus LogPeripheralAccess sysbus.timer1
sysbus LogPeripheralAccess sysbus.radio

#############################################################

mach add "node4"
mach set "node4"
machine LoadPlatformDescription @platforms/cpus/nrf52840.repl 

# set unique identification address 
sysbus Tag <0x100000a4, 0x100000a7> "DEVICEADDR[0]" 0x0000000004 false

# time quantum setup 
emulation SetGlobalQuantum "0.00001"
emulation SetQuantum "0.00001"

# analyzers 
showAnalyzer sysbus.uart0
connector Connect sysbus.radio wireless

# logging 
logLevel -1 sysbus.radio
#logLevel -1 sysbus.ppi
#logLevel -1 sysbus.rtc0
#logLevel -1 sysbus.timer0
#logLevel -1 sysbus.timer1
logLevel -1 sysbus.nvic
sysbus LogPeripheralAccess sysbus.nvic
#sysbus LogPeripheralAccess sysbus.ppi
#sysbus LogPeripheralAccess sysbus.rtc0
#sysbus LogPeripheralAccess sysbus.timer0
#sysbus LogPeripheralAccess sysbus.timer1
sysbus LogPeripheralAccess sysbus.radio

###########################################################
# mesh end 

mach add "mobile_broadcaster"
mach set "mobile_broadcaster"

machine LoadPlatformDescription @platforms/cpus/nrf52840.repl 

emulation SetGlobalQuantum "0.00001"
emulation SetQuantum "0.00001"

# analyzers 
showAnalyzer sysbus.uart0
connector Connect sysbus.radio wireless


macro reset
"""
    pause
    
    # mesh begin 

    mach set "sink"
    sysbus LoadELF $ORIGIN/../../zephyr-rtos/build/zephyr/zephyr.elf 
    
    mach set "node1"
    sysbus LoadELF $ORIGIN/../../zephyr-rtos/build/zephyr/zephyr.elf 

    mach set "node2"
    sysbus LoadELF $ORIGIN/../../zephyr-rtos/build/zephyr/zephyr.elf 

    mach set "node4"
    sysbus LoadELF $ORIGIN/../../zephyr-rtos/build/zephyr/zephyr.elf 
    
    # mesh end

    mach set "mobile_broadcaster"
    sysbus LoadELF $ORIGIN/../../mobile_broadcaster/build/zephyr/zephyr.elf
"""
runMacro $reset

start

machine StartGdbServer 3333 true
